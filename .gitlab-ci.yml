stages:
  - build
  - test
  - deploy

variables:
  IMAGE_REGISTRY: $CI_REGISTRY_IMAGE
  DOCKER_TLS_CERTDIR: ""  # Не нужно для локального Docker

# -----------------------
# Docker login job (через PAT)
# -----------------------
build-login:
  stage: build
  image: docker:20.10.16
  script:
    - echo "$CI_JOB_TOKEN" | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
  only:
    - main

# -----------------------
# Build backend images
# -----------------------
build-adcontrol-auth:
  stage: build
  image: docker:20.10.16
  script:
    - echo "Logging into GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t $IMAGE_REGISTRY/adcontrol-auth:$CI_COMMIT_SHORT_SHA -t $IMAGE_REGISTRY/adcontrol-auth:latest -f src/Server/AdControl.Auth/Dockerfile .
    - docker push $IMAGE_REGISTRY/adcontrol-auth:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_REGISTRY/adcontrol-auth:latest
  only:
    - main

build-adcontrol-web:
  stage: build
  image: docker:20.10.16
  script:
    - echo "Logging into GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t $IMAGE_REGISTRY/adcontrol-web:$CI_COMMIT_SHORT_SHA -t $IMAGE_REGISTRY/adcontrol-web:latest -f Server/AdControl.Web/AdControl.Web/Dockerfile Server/AdControl.Web
    - docker push $IMAGE_REGISTRY/adcontrol-web:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_REGISTRY/adcontrol-web:latest
  only:
    - main

build-adcontrol-gateway:
  stage: build
  image: docker:20.10.16
  script:
    - echo "Logging into GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t $IMAGE_REGISTRY/adcontrol-gateway:$CI_COMMIT_SHORT_SHA -t $IMAGE_REGISTRY/adcontrol-gateway:latest -f Server/AdControl.Gateway/AdControl.Gateway/Dockerfile Server/AdControl.Gateway
    - docker push $IMAGE_REGISTRY/adcontrol-gateway:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_REGISTRY/adcontrol-gateway:latest
  only:
    - main

build-adcontrol-avalonia-logic:
  stage: build
  image: docker:20.10.16
  script:
    - echo "Logging into GitLab Container Registry..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    - docker build -t $IMAGE_REGISTRY/adcontrol-avalonia-logic:$CI_COMMIT_SHORT_SHA -t $IMAGE_REGISTRY/adcontrol-avalonia-logic:latest -f Server/AdControl.Avalonia.Logic/AdControl.Avalonia.Logic/Dockerfile Server/AdControl.Avalonia.Logic
    - docker push $IMAGE_REGISTRY/adcontrol-avalonia-logic:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_REGISTRY/adcontrol-avalonia-logic:latest
  only:
    - main

# -----------------------
# Test stage (placeholder)
# -----------------------
unit-test-job:
  stage: test
  script:
    - echo "Unit tests placeholder"
  only:
    - main

# -----------------------
# Deploy stage (pull images & run on server)
# -----------------------
deploy-job:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync bash
    - mkdir -p ~/.ssh
    - echo "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - if [ -n "${FINGERPRINT:-}" ]; then echo "$FINGERPRINT" > ~/.ssh/known_hosts; else ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts; fi
  script:
    - rsync -avz -e "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes" docker-compose.yml "$USER@$HOST:$WORK_DIR/"
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes "$USER@$HOST" bash -lc "
        set -euo pipefail
        cd '$WORK_DIR'

        echo 'Logging into GitLab Container Registry...'
        echo '$CI_JOB_TOKEN' | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY

        echo 'Pulling images and deploying...'
        docker compose pull
        docker compose up -d

        echo 'Deploy finished'
      "
  only:
    - main
  when: on_success